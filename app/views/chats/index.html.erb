<%= render "shared/header" %>

<div class="container chat-container">
  <div class="row">
    <!-- üìå „Çµ„Ç§„Éâ„Éê„ÉºÔºàÊò†ÁîªÊÉÖÂ†±Ôºâ -->
    <div class="col-md-4 chat-sidebar">
      <h2 class="movie-title"><%= @movie_details["title"] %></h2>
      <img src="https://image.tmdb.org/t/p/w300<%= @movie_details['poster_path'] %>" alt="<%= @movie_details['title'] %>" class="movie-poster">
      <p><strong>ÂÖ¨ÈñãÊó•:</strong> <%= @movie_details["release_date"] %></p>
      <p><strong>Ë©ï‰æ°:</strong> <%= @movie_details["vote_average"] %> / 10</p>
      <p><strong>üëÄ Ë¶ñËÅ¥ËÄÖÊï∞:</strong> <%= Viewing.where(movie_id: @movie_id, active: true).count %> ‰∫∫</p>
      <%= link_to "Êò†ÁîªË©≥Á¥∞„Å´Êàª„Çã", movie_path(@movie_details["id"]), class: "btn btn-secondary mt-3" %>
    </div>

    <!-- üìå „É°„Ç§„É≥„Ç®„É™„Ç¢Ôºà„ÉÅ„É£„ÉÉ„ÉàÊ¨ÑÔºâ -->
    <div class="col-md-8 chat-main">
      <h2 class="chat-title"><%= @movie_details["title"] %> „ÅÆ„ÉÅ„É£„ÉÉ„Éà</h2>
      <div id="chats" class="chat-box">
        <% if @chats.present? %>
          <% @chats.each do |chat| %>
            <div class="chat-message <%= chat.user == current_user ? 'my-message' : 'other-message' %>">
              <% unless chat.user == current_user %>
                <div class="chat-user-message">
                  <!-- ‚úÖ „É¶„Éº„Ç∂„Éº„ÅÆ„Ç¢„Ç§„Ç≥„É≥„ÇíË°®Á§∫„Åó„ÄÅ„ÇØ„É™„ÉÉ„ÇØ„ÅßË©≥Á¥∞„Éö„Éº„Ç∏„Å∏ÈÅ∑Áßª -->
                  <%= link_to user_path(chat.user), class: "chat-user-link" do %>
                    <% if chat.user.avatar.attached? %>
                      <%= image_tag chat.user.avatar.variant(resize_to_limit: [40, 40]), class: "chat-user-icon" %>
                    <% else %>
                      <%= image_tag "default_avatar.png", class: "chat-user-icon", alt: "„Éá„Éï„Ç©„É´„Éà„Ç¢„Éê„Çø„Éº" %>
                    <% end %>
                  <% end %>
                  <div class="message-bubble"><%= chat.message %></div>
                </div>
              <% else %>
                <div class="message-bubble"><%= chat.message %></div>
              <% end %>
            </div>
          <% end %>
        <% else %>
          <p>„Åæ„Å†„É°„ÉÉ„Çª„Éº„Ç∏„Åå„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ</p>
        <% end %>
      </div>

      <!-- „ÉÅ„É£„ÉÉ„Éà„Éï„Ç©„Éº„É† -->
      <div class="chat-form">
        <% if user_signed_in? %>
          <%= form_with model: [@movie_id, @chat], url: movie_chats_path(@movie_id), id: "chat-form", class: "d-flex w-100" do |f| %>
            <%= f.text_area :message, class: "chat-text", placeholder: "„É°„ÉÉ„Çª„Éº„Ç∏„ÇíÂÖ•Âäõ..." %>
            <%= f.submit "ÈÄÅ‰ø°", class: "chat-submit btn btn-primary" %>
          <% end %>
        <% end %>
      </div>
    </div>
  </div>
</div>
